<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>12.1.2 Configuring Hibernate 1.0.0.BUILD-SNAPSHOT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/quickStart.html"><strong>2</strong><span>Quick Start</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/ioc.html"><strong>3</strong><span>Inversion of Control</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/config.html"><strong>4</strong><span>Application Configuration</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/aop.html"><strong>5</strong><span>Aspect Oriented Programming</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/httpServer.html"><strong>6</strong><span>The HTTP Server</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/httpClient.html"><strong>7</strong><span>The HTTP Client</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/cloud.html"><strong>8</strong><span>Cloud Native Features</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/serverlessFunctions.html"><strong>9</strong><span>Serverless Functions</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/messaging.html"><strong>10</strong><span>Message-Driven Microservices</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/commandLineApps.html"><strong>11</strong><span>Standalone Command Line Applications</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/configurations.html"><strong>12</strong><span>Configurations</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/languageSupport.html"><strong>13</strong><span>Language Support</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/security.html"><strong>15</strong><span>Security</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/multitenancy.html"><strong>16</strong><span>Multi-Tenancy</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/cli.html"><strong>17</strong><span>Micronaut CLI</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/appendix.html"><strong>18</strong><span>Appendices</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/commandLineApps.html">&lt;&lt; <strong>11</strong><span>Standalone Command Line Applications</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/languageSupport.html"><strong>13</strong><span>Language Support</span> >></a></div>
                


                <div class="project">
                    <h1>12.1.2 Configuring Hibernate</h1>

                    <p><strong>Version:</strong> 1.0.0.BUILD-SNAPSHOT</p>
                </div>

                

                

<h2 id="hibernateSupport">12.1.2 Configuring Hibernate</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/configurations/dataAccess/hibernateSupport.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect3">
<h4 id="_setting_up_a_hibernate_jpa_entitymanager">Setting up a Hibernate/JPA EntityManager</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Using the CLI</div>
<div class="paragraph">
<p>If you are creating your project using the Micronaut CLI, supply the <code>hibernate-jpa</code> feature to include a Hibernate JPA configuration in your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mn create-app my-app --features hibernate-jpa</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Micronaut features built in support for configuring a <a href="http://hibernate.org">Hibernate</a> / JPA <code>EntityManager</code> that builds on the <a href="#sqlSupport">SQL DataSource support</a>.</p>
</div>
<div class="paragraph">
<p>Once you have <a href="#sqlSupport">configured one or many DataSources</a> to use Hibernate, you will need to add the <code>hibernate-jpa</code> dependency to your build configuration:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">compile "io.micronaut.configuration:hibernate-jpa"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that is it. For each registered SQL <code>DataSource</code>, Micronaut will configure the following beans using <a href="../api/io/micronaut/configuration/hibernate/jpa/EntityManagerFactoryBean.html">EntityManagerFactoryBean</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/boot/registry/StandardServiceRegistry.html">StandardServiceRegistry</a> - The Hibernate <code>StandardServiceRegistry</code></p>
</li>
<li>
<p><a href="http://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/boot/MetadataSources.html">MetadataSources</a> - The Hibernate <code>MetadataSources</code></p>
</li>
<li>
<p><a href="http://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/boot/SessionFactoryBuilder.html">SessionFactoryBuilder</a> - The Hibernate <code>SessionFactoryBuilder</code></p>
</li>
<li>
<p><a href="http://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/SessionFactory.html">SessionFactory</a> - The Hibernate <code>SessionFactory</code> bean which also implements the JPA <code>EntityManagerFactory</code> interface.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_injecting_an_entitymanager_or_hibernate_session">Injecting an EntityManager or Hibernate Session</h4>
<div class="paragraph">
<p>You can use the <code>javax.persistence.PersistenceContext</code> annotation to inject an <code>EntityManager</code> (or Hibernate <code>Session</code>). To do so you need to make sure the JPA annotations are on the <code>annotationProcessor</code> path in your build:</p>
</div>
<div class="listingblock">
<div class="title">Adding the JPA dependency to <code>annotationProcessor</code> in Gradle</div>
<div class="content">
<pre>annotationProcessor "javax.persistence:javax.persistence-api:2.2"</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using <code>@PersistenceContext</code></div>
<div class="content">
<pre>@PersistenceContext
EntityManager entityManager;

@PersistenceContext(name = "other")
EntityManager otherManager;</pre>
</div>
</div>
<div class="paragraph">
<p>Micronaut will inject a compile time scoped proxy that retrieves the <code>EntityManager</code> associated with the current transaction when using <a href="../api/io/micronaut/spring/tx/annotation/Transactional.html">@Transactional</a> (see "Using Spring Transaction Management" below).</p>
</div>
<div class="paragraph">
<p>Note the examples above use field injection, since the <code>@PersistenceContext</code> annotation does not support declaration on a parameter of a constructor or method argument. Therefore if you wish to instead use constructor or method injection you must use the <a href="../api/io/micronaut/configuration/hibernate/jpa/scope/CurrentSession.html">@CurrentSession</a> instead:</p>
</div>
<div class="listingblock">
<div class="title">Using <code>@CurrentSession</code> for constructor injection</div>
<div class="content">
<pre>MyService(@CurrentSession EntityManager entityManager) {
     this.entityManager = entityManager;
}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_customizing_hibernate_jpa_configuration">Customizing Hibernate / JPA Configuration</h4>
<div class="paragraph">
<p>There are several different ways you can customize and configure how the <code>SessionFactory</code> is built. The easiest way is via configuration in <code>application.yml</code>. The following configuration demonstrates an example:</p>
</div>
<div class="listingblock">
<div class="title">Configuring Hibernate Properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">datasources:
    default:
        name: 'mydb'
jpa:
    default:
        packages-to-scan:
            - 'foo.bar'
            - 'foo.baz'
        properties:
            hibernate:
                hbm2ddl:
                    auto: update
                show_sql: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example configures the packages to be scanned and sets properties to be passed to Hibernate. As you can see these are done on a per <code>DataSource</code> basis. Refer to the <a href="../api/io/micronaut/configuration/hibernate/jpa/JpaConfiguration.html">JpaConfiguration</a> configuration class for the possible options.</p>
</div>
<div class="paragraph">
<p>If you need even further control over how the <code>SessionFactory</code> is built then you can register <a href="../api/io/micronaut/context/event/BeanCreatedEventListener.html">BeanCreatedEventListener</a> beans that listen for the creation of the <a href="http://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/boot/SessionFactoryBuilder.html">SessionFactoryBuilder</a>, <a href="http://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/boot/MetadataSources.html">MetadataSources</a> etc. and apply your custom configuration in the listener.</p>
</div>
<div class="paragraph">
<p>You may also optionally create beans of type <a href="http://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/integrator/spi/Integrator.html">Integrator</a> and <a href="http://docs.jboss.org/hibernate/orm/current/javadocs/org/hibernate/Interceptor.html">Interceptor</a> and these will be picked up and injected automatically.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_spring_transaction_management">Using Spring Transaction Management</h4>
<div class="paragraph">
<p>Micronaut&#8217;s Hibernate integration will also automatically provide a Spring <code>HibernateTransactionManager</code> bean so you can use Spring-based transaction management.</p>
</div>
<div class="paragraph">
<p>You should use Micronaut&#8217;s <a href="../api/io/micronaut/spring/tx/annotation/Transactional.html">@Transactional</a> annotation to ensure low-overhead, compile-time transaction management is applied to your classes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_understanding_lazyinitializationexception">Understanding LazyInitializationException</h4>
<div class="paragraph">
<p>Micronaut is built on Netty which is based on a non-blocking, event loop model. JDBC and Hibernate are blocking APIs and hence when they are used in a Micronaut application the work is shifted to a blocking I/O thread pool.</p>
</div>
<div class="paragraph">
<p>When using <a href="../api/io/micronaut/spring/tx/annotation/Transactional.html">@Transactional</a> the Hibernate <code>Session</code> will only be open for the duration of this method execution and then will automatically be closed. This ensures that the blocking operation is kept as short as possible.</p>
</div>
<div class="paragraph">
<p>There is no notion of OpenSessionInView (OSIV) in Micronaut and never will be, since it is <a href="https://vladmihalcea.com/the-open-session-in-view-anti-pattern/">sub-optimal and not recommended</a>. You should optimize the queries that you write to return all the necessary data Micronaut will need to encode your objects into JSON either by using the appropriate join queries or using a <a href="https://vladmihalcea.com/the-best-way-to-map-a-projection-query-to-a-dto-with-jpa-and-hibernate/">data transfer object (DTO)</a>.</p>
</div>
<div class="paragraph">
<p>If you encounter a <code>LazyInitializationException</code> when returning a Hibernate entity from a method it is an indication that your query is suboptimal and you should perform a join.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_gorm_for_hibernate">Using GORM for Hibernate</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Using the CLI</div>
<div class="paragraph">
<p>If you are creating your project using the Micronaut CLI, supply the <code>hibernate-gorm</code> feature to include GORM, a basic connection pool configuration, and a default H2 database driver in your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ mn create-app my-app --features hibernate-gorm</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For Groovy users and users familiar with the Grails framework, special support for <a href="http://gorm.grails.org">GORM for Hibernate</a> is available. To use GORM for Hibernate you <strong>should not</strong> include Micronaut&#8217;s built in <a href="#sqlSupport">SQL Support</a> or the <code>hibernate-jpa</code> dependency since GORM itself takes responsibility for creating the <code>DataSource</code>, <code>SessionFactory</code> etc.</p>
</div>
<div class="paragraph">
<p>Rather, you only need to include the  <code>hibernate-gorm</code> dependency in your project, a connection pool implementation, and the desired JDBC driver. For example:</p>
</div>
<div class="listingblock">
<div class="title">Configuring GORM for Hibernate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy hljs" data-lang="groovy">  compile "io.micronaut.configuration:hibernate-gorm"
  // Use Tomcat connection pool
  runtime 'org.apache.tomcat:tomcat-jdbc:8.0.44'
  // Use H2 database driver
  runtime  'com.h2database:h2:1.4.196'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now use the same <a href="http://gorm.grails.org/latest/hibernate/manual/index.html#configuration">configuration properties described in the GORM documentation</a>. For example:</p>
</div>
<div class="listingblock">
<div class="title">Configuring GORM for Hibernate</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">dataSource:
    pooled: true
    dbCreate: create-drop
    url: jdbc:h2:mem:devDb
    driverClassName: org.h2.Driver
    username: sa
    password:
hibernate:
    cache:
        queries: false
        use_second_level_cache: true
        use_query_cache: false
        region.factory_class: org.hibernate.cache.ehcache.EhCacheRegionFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following should be noted regarding using GORM for Hibernate in Micronaut:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each class you wish to be a GORM entity should be annotated with the <code>grails.gorm.annotation.Entity</code> annotation.</p>
</li>
<li>
<p>Each method that interacts with GORM should be annotated with GORM&#8217;s <code>grails.gorm.transactions.Transactional</code> to ensure a session is present. You can also add the <code>@Transactional</code> annotation to the class.</p>
</li>
<li>
<p>By default Micronaut will scan for entities relative to your <code>Application</code> class. If you wish to customize this specify additional packages via the <a href="../api/io/micronaut/context/ApplicationContextBuilder.html">ApplicationContextBuilder</a> when starting your application.</p>
</li>
</ul>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/commandLineApps.html">&lt;&lt; <strong>11</strong><span>Standalone Command Line Applications</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/languageSupport.html"><strong>13</strong><span>Language Support</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
