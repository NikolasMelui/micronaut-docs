<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>13.4 Micronaut for GraalVM 1.0.1.BUILD-SNAPSHOT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/quickStart.html"><strong>2</strong><span>Quick Start</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/ioc.html"><strong>3</strong><span>Inversion of Control</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/config.html"><strong>4</strong><span>Application Configuration</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/aop.html"><strong>5</strong><span>Aspect Oriented Programming</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/httpServer.html"><strong>6</strong><span>The HTTP Server</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/httpClient.html"><strong>7</strong><span>The HTTP Client</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/cloud.html"><strong>8</strong><span>Cloud Native Features</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/serverlessFunctions.html"><strong>9</strong><span>Serverless Functions</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/messaging.html"><strong>10</strong><span>Message-Driven Microservices</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/commandLineApps.html"><strong>11</strong><span>Standalone Command Line Applications</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/configurations.html"><strong>12</strong><span>Configurations</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/languageSupport.html"><strong>13</strong><span>Language Support</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/security.html"><strong>15</strong><span>Security</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/multitenancy.html"><strong>16</strong><span>Multi-Tenancy</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/cli.html"><strong>17</strong><span>Micronaut CLI</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/appendix.html"><strong>18</strong><span>Appendices</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/configurations.html">&lt;&lt; <strong>12</strong><span>Configurations</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span> >></a></div>
                


                <div class="project">
                    <h1>13.4 Micronaut for GraalVM</h1>

                    <p><strong>Version:</strong> 1.0.1.BUILD-SNAPSHOT</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#graalServices"><strong>13.1</strong><span>Microservices as GraalVM native images</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#graalFAQ"><strong>13.2</strong><span>GraalVM and Micronaut FAQ</span></a>
                    </div>
                    
                </div>
                

                

<h2 id="graal">13.4 Micronaut for GraalVM</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/languageSupport/graal.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="https://www.graalvm.org">GraalVM</a> is a new universal virtual machine from Oracle that supports a polyglot runtime environment and the ability to compile Java applications down to native machine code.</p>
</div>
<div class="paragraph">
<p>Any Micronaut application can be run using the GraalVM JVM, however special support has been added to Micronaut to support running Micronaut applications using <a href="https://www.graalvm.org/docs/reference-manual/aot-compilation/">GraalVM&#8217;s <code>nativeimage</code> tool</a>.</p>
</div>
<div class="sect2">
<h3 id="_experimental_status">Experimental Status</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
GraalVM support (like GraalVM itself) is still in the incubating phase. Third-party library support is hit and miss and the Micronaut team are still ironing out all of the potential issues. Don&#8217;t hesitate to <a href="https://github.com/micronaut-projects/micronaut-core/issues">report issues</a> however and gradually over time the support will become more stable.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So far Micronaut&#8217;s HTTP server, HTTP client, function support and service discovery module have been verified as working on GraalVM 1.0 RC6 or above. Support for other modules is still evolving and will improve over time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_getting_started">Getting Started</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Use of GraalVM&#8217;s <code>nativeimage</code> tool is only supported in Java or Kotlin projects. Groovy relies heavily on reflection which is only partially supported by GraalVM.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To start using GraalVM you should first install the GraalVM SDK via the <a href="https://www.graalvm.org/docs/getting-started/">Getting Started</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
As of this writing, GraalVM is currently only available for Linux and Mac OS X systems.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To compile Micronaut and Graal applications you need to make the substrate VM dependency available to your application. The easiest way to make it available is via Docker:</p>
</div>
<div class="listingblock">
<div class="title">Using Docker to Obtain the SVM Dependency</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run oracle/graalvm-ce:1.0.0-rc7 cat /usr/java/latest/jre/lib/svm/builder/svm.jar &gt; svm.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have obtained the <code>svm.jar</code> from the latest Graal Docker images you can install it into your local Maven cache:</p>
</div>
<div class="listingblock">
<div class="title">Installing the SVM Dependency Locally</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ mvn install:install-file -Dfile=svm.jar \
                           -DgroupId=com.oracle.substratevm \
                           -DartifactId=svm \
                           -Dversion=GraalVM-1.0.0-rc7 \
                           -Dpackaging=jar</code></pre>
</div>
</div>
</div>


<h2 id="graalServices">13.4.1 Microservices as GraalVM native images</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/languageSupport/graal/graalServices.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect2">
<h3 id="_getting_started_with_micronaut_and_graal">Getting Started with Micronaut and Graal</h3>
<div class="paragraph">
<p>To get started creating a Microservice that can be compiled into a native image, use the <code>graal-native-image</code> feature when creating the application with the CLI:</p>
</div>
<div class="listingblock">
<div class="title">Creating a Graal Native Microservice</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ mn create-app hello-world --features graal-native-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>graal-native-image</code> feature adds 3 important items:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A <code>MicronautSubstitutions.java</code> file needed to recompute Netty and Caffeine&#8217;s use of <code>Unsafe</code>.</p>
</li>
<li>
<p>The <code>svm</code> and <code>graal</code> dependencies to your <code>build.gradle</code> (or <code>pom.xml</code> if <code>--build maven</code> is used).</p>
</li>
<li>
<p>A <code>Dockerfile</code> which can be used to construct the native image.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To build your native image using Docker simply run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ docker build . -t hello-world
$ docker run hello-world</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_micronaut_and_graal">Understanding Micronaut and Graal</h3>
<div class="paragraph">
<p>Although Micronaut Dependency Injection does not use reflection, Micronaut does heavily rely on dynamic class loading. GraalVM needs to know ahead of time all the classes that are to be dynamically loaded.</p>
</div>
<div class="paragraph">
<p>So before you can build a native image Micronaut needs to compute your application&#8217;s classloading requirements. The <code>Dockerfile</code> does this automatically for you, but you can also run the logic to generate Graal&#8217;s <code>reflect.json</code> file manually:</p>
</div>
<div class="listingblock">
<div class="title">Computing Class Loading Requirements</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./gradlew assemble
$ java -cp build/libs/hello-world-0.1-all.jar io.micronaut.graal.reflect.GraalClassLoadingAnalyzer</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>GraalClassLoadingAnalyzer</code> will write out a <code>reflect.json</code> file computing the classloading requirements of the application.</p>
</div>
<div class="paragraph">
<p>The default is to write this file to the <code>build</code> directory for Gradle and the <code>target</code> directory for Maven. You can alter the destination by specifying an argument:</p>
</div>
<div class="listingblock">
<div class="title">Writing <code>reflect.json</code> to a custom location</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ java -cp build/libs/hello-world-0.1-all.jar io.micronaut.graal.reflect.GraalClassLoadingAnalyzer somelocation/myreflect.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated <code>reflect.json</code> file contains the classes that were dynamically loaded by the application when started up. See <a href="https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md">GraalVM documentation</a> for information on the JSON format.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you wish you can use this file as a template and copy it to the source tree, making modifications as necessary and then altering the <code>Dockerfile</code> template to point to the new location.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the <code>reflect.json</code> file is ready you can run the <code>native-image</code> command. The script runs the following <code>native-image</code> command:</p>
</div>
<div class="listingblock">
<div class="title">The <code>native-image</code> command</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">native-image --class-path build/libs/hello-world-0.1-all.jar \ <i class="conum" data-value="1"></i><b>(1)</b>
			 -H:ReflectionConfigurationFiles=build/reflect.json \ <i class="conum" data-value="2"></i><b>(2)</b>
			 -H:EnableURLProtocols=http \ <i class="conum" data-value="3"></i><b>(3)</b>
			 -H:IncludeResources="logback.xml|application.yml|META-INF/services/*.*" \ <i class="conum" data-value="4"></i><b>(4)</b>
			 -H:Name=hello-world \ <i class="conum" data-value="5"></i><b>(5)</b>
			 -H:Class=hello.world.Application \ <i class="conum" data-value="6"></i><b>(6)</b>
			 -H:+ReportUnsupportedElementsAtRuntime \ <i class="conum" data-value="7"></i><b>(7)</b>
			 -H:+AllowVMInspection \
			 --rerun-class-initialization-at-runtime='sun.security.jca.JCAUtil$CachedSecureRandomHolder,javax.net.ssl.SSLContext' \
			 --delay-class-initialization-to-runtime=io.netty.handler.codec.http.HttpObjectEncoder,io.netty.handler.codec.http.websocketx.WebSocket00FrameEncoder,io.netty.handler.ssl.util.ThreadLocalInsecureRandom <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>class-path</code> argument is used to refer to the Micronaut shaded JAR</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>-H:ReflectionConfigurationFiles</code> points GraalVM to the <code>reflect.json</code> file needed to run the application</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Micronaut uses the JVM&#8217;s default URL connection classes. The <code>-H:EnableURLProtocols</code> allows using them in GraalVM <code>nativeimage</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>-H:IncludeResources</code> argument specifies a regex to dictate which static resources should be included in the image.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>-H:Name</code> argument specifies the name of the native image to be built</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>-H:Class</code> argument specifies the Java main class that is the entry point of the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The <code>-H:+ReportUnsupportedElementsAtRuntime</code> tells GraalVM to report any <code>ClassNotFoundException</code> errors at runtime instead of at build time.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The <code>--delay-class-initialization-to-runtime</code> specifies which classes static initializers should be delayed until runtime. GraalVM by default runs static initializers at build time. That is undesirable is certain cases (particularly with Netty).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the image has been built you can run the application using the native image name:</p>
</div>
<div class="listingblock">
<div class="title">Running the Native Application</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ ./hello-world
15:15:15.153 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 14ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the advantage of having a native image is startup completes in milliseconds and memory consumption does not include the overhead of the JVM (a native Micronaut application runs with just 20mb of memory).</p>
</div>
</div>


<h2 id="graalFAQ">13.4.2 GraalVM and Micronaut FAQ</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-projects/micronaut-core/edit/master/src/main/docs/guide/languageSupport/graal/graalFAQ.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="sect3">
<h4 id="_how_does_micronaut_manage_to_run_on_graalvm">How does Micronaut manage to run on GraalVM?</h4>
<div class="paragraph">
<p>Micronaut features a Dependency Injection and Aspect-Oriented Programming runtime that uses no reflection. This makes it easier for Micronaut applications to run on GraalVM since there are <a href="https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md">limitations</a> particularly around <a href="https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md">reflection</a> on SubstrateVM.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_about_third_party_libraries">What about Third-Party Libraries?</h4>
<div class="paragraph">
<p>Micronaut cannot guarantee that third-party libraries work on GraalVM SubstrateVM, that is down to each individual library to implement support.</p>
</div>
</div>
<div class="sect3">
<h4 id="_i_get_a_class_xxx_is_instantiated_reflectively_exception_what_do_i_do">I Get a "Class XXX is instantiated reflectively&#8230;&#8203;" Exception. What do I do?</h4>
<div class="paragraph">
<p>If you get an error such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Class myclass.Foo[] is instantiated reflectively but was never registered. Register the class by using org.graalvm.nativeimage.RuntimeReflection</pre>
</div>
</div>
<div class="paragraph">
<p>You may need to manually tweak the generated <code>reflect.json</code> file. For regular classes you need to add an entry into the array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
    {
        "name" : "myclass.Foo",
        "allDeclaredConstructors" : true
    },
    ...
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>For arrays this needs to use the Java JVM internal array representation. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
    {
        "name" : "[Lmyclass.Foo;",
        "allDeclaredConstructors" : true
    },
    ...
]</code></pre>
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/configurations.html">&lt;&lt; <strong>12</strong><span>Configurations</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/management.html"><strong>14</strong><span>Management &amp; Monitoring</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
